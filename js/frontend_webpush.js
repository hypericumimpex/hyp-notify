 "use strict"; var smpush_isPushEnabled = false; var devicetype = smpush_browser(); var settings = JSON.parse('{"chrome":1,"firefox":1,"opera":1,"edge":0,"samsung":1,"safari":1}'); smpush_debug(devicetype); function smpush_debug(object) { if(1 == 1){ console.log(object); } } function smpushUrlB64ToUint8Array(base64String) { const padding = "=".repeat((4 - base64String.length % 4) % 4); const base64 = (base64String + padding) .replace(/\-/g, "+") .replace(/_/g, "/"); const rawData = window.atob(base64); const outputArray = new Uint8Array(rawData.length); for (let i = 0; i < rawData.length; ++i) { outputArray[i] = rawData.charCodeAt(i); } return outputArray; } function smpush_endpoint_subscribe(subscriptionId) { if(subscriptionId == ""){ return false; } smpush_setCookie("smpush_desktop_request", "true", 365); smpush_setCookie("smpush_device_token", subscriptionId, 365); var data = {}; data["device_token"] = subscriptionId; data["device_type"] = devicetype; data["active"] = 1; data["latitude"] = (smpush_getCookie("smart_push_smio_coords_latitude") != "")? smpush_getCookie("smart_push_smio_coords_latitude") : ""; data["longitude"] = (smpush_getCookie("smart_push_smio_coords_longitude") != "")? smpush_getCookie("smart_push_smio_coords_longitude") : ""; var subsChannels = []; jQuery("input.smpush_desktop_channels_subs:checked").each(function(index) { subsChannels.push(jQuery(this).val()); }); subsChannels = subsChannels.join(","); if(jQuery(".smpush-push-subscriptions-button").length > 0 && jQuery("#smpush_subscription_form").length == 0){ var apiService = "channels_subscribe"; data["channels_id"] = subsChannels; } else{ var apiService = "savetoken"; } smpushDestroyReqWindow(false); jQuery.ajax({ method: "POST", url: "https://smart-local.com/wp/?smpushcontrol="+apiService, data: data }) .done(function( msg ) { smpushWelcomeMSG(); jQuery(".smpush-push-subscriptions-button").attr("disabled","disabled"); jQuery(".smpush-push-subscriptions-button").html("Saved !"); smpush_debug("Data Sent"); if(0 == 1){ smpushUpdateGPS(); } smpush_link_user_cookies(); }); } function smpush_endpoint_unsubscribe(subscriptionId) { jQuery("#smpushIconRequest").tooltipster("content","Give us a permission to receive push notification messages and we will keep you posted !"); jQuery.ajax({ method: "POST", url: "https://smart-local.com/wp/?smpushcontrol=deletetoken", data: { device_token: subscriptionId, device_type: devicetype} }) .done(function( msg ) { smpush_debug("Data Sent"); smpush_setCookie("smpush_linked_user", "false", -1); smpush_setCookie("smpush_safari_device_token", "false", -1); smpush_setCookie("smpush_device_token", "false", -1); smpush_setCookie("smpush_desktop_request", "false", -1); smpush_setCookie("smpush_desktop_welcmsg_seen", "false", -1); }); } function smpush_test_browser(){ if("safari" in window && "pushNotification" in window.safari){ return true; } if (typeof(ServiceWorkerRegistration) != "undefined" && ("showNotification" in ServiceWorkerRegistration.prototype)) { return true; } if(Notification.permission === "denied"){ return false; } return false; } function smpush_browser() { if("safari" in window){ return "safari"; } if (navigator.userAgent.indexOf(" OPR/") >= 0) { return "opera"; } if (navigator.userAgent.indexOf("Edge") >= 0) { return "edge"; } if (navigator.userAgent.match(/chrome/i)) { return "chrome"; } if (navigator.userAgent.match(/SamsungBrowser/i)) { return "samsung"; } if (navigator.userAgent.match(/firefox/i)) { return "firefox"; } } function smpush_bootstrap_init(){ if(settings[devicetype] == 0){ smpush_debug("Browser support is closed by admin settings"); return; } var pushSupported = smpush_test_browser(); if(! pushSupported){ smpushDrawUnSupportedPopup(); smpush_debug("Browser not support push notification"); return; } if(smpush_getCookie("smpush_desktop_request") != "true"){ jQuery("body").append("<style></style>"); setTimeout(function(){ smpushDrawReqWindow() }, 0); } else{ smpush_link_user_cookies(); if(0 == 1){ smpushUpdateGPS(); } var pushButton = jQuery(".smpush-push-permission-button"); smpush_isPushEnabled = true; pushButton.html("Unsubscribe"); jQuery("#smpushIconRequest").tooltipster("content","Unsubscribe from receiving our notifications and delete your subscription"); pushButton.removeAttr("disabled"); jQuery(".smpush-push-subscriptions-button").removeAttr("disabled"); jQuery(".smpush-push-subscriptions-button").click(function() { smpush_endpoint_subscribe(smpush_getCookie("smpush_device_token")); }); pushButton.click(function() { smpush_endpoint_unsubscribe(smpush_getCookie("smpush_device_token")); jQuery(".smpush-push-permission-button").remove(); jQuery(".smpush-push-subscriptions-button").remove(); }); } smpushDrawReqIcon(); } function smpushUpdateGPS(){ if(smpush_getCookie("smpush_device_token") != "" && smpush_getCookie("smart_push_smio_coords_latitude") == ""){ if (! navigator.geolocation) { smpush_debug("Geolocation is not supported for this Browser/OS."); return; } var geoSuccess = function(startPos) { smpush_debug(startPos.coords.latitude); smpush_debug(startPos.coords.longitude); smpush_setCookie("smart_push_smio_coords_latitude", startPos.coords.latitude, (1/24)); smpush_setCookie("smart_push_smio_coords_longitude", startPos.coords.longitude, (1/24)); smpush_endpoint_subscribe(smpush_getCookie("smpush_device_token")); }; var geoError = function(error) { smpush_debug("Error occurred. Error code: " + error.code); /*0: unknown error, 1: permission denied, 2: position unavailable (error response from location provider), 3: timed out*/ }; navigator.geolocation.getCurrentPosition(geoSuccess); } } function smpushDestroyReqWindow(dismiss){ jQuery("#smart_push_smio_window").remove(); jQuery("#smart_push_smio_overlay").remove(); if(dismiss){ var requestAgainPeriod = 3; } else{ var requestAgainPeriod = 365; } smpush_setCookie("smpush_desktop_request", "true", requestAgainPeriod); if("0" == "2" && jQuery("#SMIOPayToReadButton").length > 0 && smpush_getCookie("smpush_device_token") != ""){ location.reload(); } } function smpushDrawNotifyPopup(){ if("0" != "1")return; jQuery("#smart_push_smio_window").remove(); jQuery("#smart_push_smio_overlay").remove(); jQuery("body").append('<style> #smart_push_smio_window{ direction:ltr;display: none;width:540px;max-width: 87%;background-color: #373737; font-family: Helvetica Neue, Helvetica, Arial, sans-serif; padding: 12px 0; border-radius: 5px; text-align: left; overflow: hidden; z-index: 99999999; } #smart_push_smio_logo{ float:left;width:80px;height:80px;margin-left:10px;border:0; } #smart_push_smio_msg{ margin-left:100px;margin-top: 23px;color: #e1e1df; font-size: 18px; font-weight: 300;padding: 0 5px 0 0;line-height: normal; } #smart_push_smio_note{ color: #828284;font-size: 15px;font-weight: 300; position: relative;margin:56px 0 20px 0;padding:20px 5px;line-height: normal;border-top: solid 1px #464646;border-bottom: solid 1px #464646;text-align: center; } #smart_push_smio_agreement{ color: #828284;font-size: 12px;font-weight: 300; position: relative;padding:0 10px 10px 10px;line-height: normal; } #smart_push_smio_footer{ text-align: center; } #smart_push_smio_not_allow{ background-color: #5f5f5f;text-transform: none; color: #929292; border: none; box-shadow: none; font-size: 17px; font-weight: 500; -webkit-border-radius: 20px; border-radius: 20px; padding: 10px 32px; margin: 5px; cursor: pointer; } #smart_push_smio_allow{ background-color: #5db166;text-transform: none; color: #fff; border: none; box-shadow: none; font-size: 17px; font-weight: 500; -webkit-border-radius: 20px; border-radius: 20px; padding: 10px 32px; margin: 5px ; cursor: pointer; } </style> <div id="smart_push_smio_overlay" tabindex="-1" style="opacity:0.9; display: none;ms-filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=40); background-color:#000; position: fixed; left: 0; right: 0; top: 0; bottom: 0; z-index: 10000;"></div> <div id="smart_push_smio_window" class="smart_push_gdpr_enabled"> <div id="smart_push_smio_close" onclick="smpushDestroyReqWindow(true)" style="display:none"></div> <img id="smart_push_smio_logo" src="https://smart-local.com/wp/wp-content/uploads/2019/01/bIT66BZ__400x400-1-300x300.png" /> <p id="smart_push_smio_msg">Subscribe to receive new offers</p> <p id="smart_push_smio_note">You can not continue browsing website without approve on this permissions</p> <p id="smart_push_smio_agreement">By proceeding in this form you will receive our marketing notifications and agree to our <a href="https://smart-local.com/wp/privacy-policy" target="_blank">Privacy Policy</a> and <a href="https://smart-local.com/wp/terms-conditions" target="_blank">Terms of Use</a></p> <div id="smart_push_smio_footer"> <button type="button" onclick="smpushDestroyReqWindow(true)" id="smart_push_smio_not_allow">Disallow</button> <button type="button" class="smpush-push-permission-button" id="smart_push_smio_allow" disabled>Subscribe</button> </div> </div> '); document.getElementById("smart_push_smio_overlay").style.opacity = "0.9"; document.getElementById("smart_push_smio_window").style.position = "fixed"; document.getElementById("smart_push_smio_overlay").style.display = "block"; document.getElementById("smart_push_smio_window").style.display = "block"; document.getElementById("smart_push_smio_window").style.left = ((window.innerWidth/2) - (document.getElementById("smart_push_smio_window").offsetWidth/2)) + "px"; document.getElementById("smart_push_smio_window").style.top = ((window.innerHeight/2) - (document.getElementById("smart_push_smio_window").offsetHeight/2)) + "px"; } function smpushDrawUnSupportedPopup(){ if("0" != "1")return; jQuery("#smart_push_smio_window").remove(); jQuery("#smart_push_smio_overlay").remove(); jQuery("body").append('<style> #smart_push_smio_window{ direction:ltr;display: none;width:540px;max-width: 87%;background-color: #373737; font-family: Helvetica Neue, Helvetica, Arial, sans-serif; padding: 12px 0; border-radius: 5px; text-align: left; overflow: hidden; z-index: 99999999; } #smart_push_smio_logo{ float:left;width:80px;height:80px;margin-left:10px;border:0; } #smart_push_smio_msg{ margin-left:100px;margin-top: 23px;color: #e1e1df; font-size: 18px; font-weight: 300;padding: 0 5px 0 0;line-height: normal; } #smart_push_smio_note{ color: #828284;font-size: 15px;font-weight: 300; position: relative;margin:56px 0 20px 0;padding:20px 5px;line-height: normal;border-top: solid 1px #464646;border-bottom: solid 1px #464646;text-align: center; } #smart_push_smio_agreement{ color: #828284;font-size: 12px;font-weight: 300; position: relative;padding:0 10px 10px 10px;line-height: normal; } #smart_push_smio_footer{ text-align: center; } #smart_push_smio_not_allow{ background-color: #5f5f5f;text-transform: none; color: #929292; border: none; box-shadow: none; font-size: 17px; font-weight: 500; -webkit-border-radius: 20px; border-radius: 20px; padding: 10px 32px; margin: 5px; cursor: pointer; } #smart_push_smio_allow{ background-color: #5db166;text-transform: none; color: #fff; border: none; box-shadow: none; font-size: 17px; font-weight: 500; -webkit-border-radius: 20px; border-radius: 20px; padding: 10px 32px; margin: 5px ; cursor: pointer; } </style> <div id="smart_push_smio_overlay" tabindex="-1" style="opacity:0.9; display: none;ms-filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=40); background-color:#000; position: fixed; left: 0; right: 0; top: 0; bottom: 0; z-index: 10000;"></div> <div id="smart_push_smio_window" class="smart_push_gdpr_enabled"> <div id="smart_push_smio_close" onclick="smpushDestroyReqWindow(true)" style="display:none"></div> <img id="smart_push_smio_logo" src="https://smart-local.com/wp/wp-content/uploads/2019/01/bIT66BZ__400x400-1-300x300.png" /> <p id="smart_push_smio_msg">Subscribe to receive new offers</p> <p id="smart_push_smio_note"></p> <p id="smart_push_smio_agreement">By proceeding in this form you will receive our marketing notifications and agree to our <a href="https://smart-local.com/wp/privacy-policy" target="_blank">Privacy Policy</a> and <a href="https://smart-local.com/wp/terms-conditions" target="_blank">Terms of Use</a></p> <div id="smart_push_smio_footer"> <button type="button" onclick="smpushDestroyReqWindow(true)" id="smart_push_smio_not_allow">Disallow</button> <button type="button" class="smpush-push-permission-button" id="smart_push_smio_allow" disabled>Subscribe</button> </div> </div> '); document.getElementById("smart_push_smio_overlay").style.opacity = "0.9"; document.getElementById("smart_push_smio_window").style.position = "fixed"; document.getElementById("smart_push_smio_overlay").style.display = "block"; document.getElementById("smart_push_smio_window").style.display = "block"; document.getElementById("smart_push_smio_window").style.left = ((window.innerWidth/2) - (document.getElementById("smart_push_smio_window").offsetWidth/2)) + "px"; document.getElementById("smart_push_smio_window").style.top = ((window.innerHeight/2) - (document.getElementById("smart_push_smio_window").offsetHeight/2)) + "px"; document.getElementById("smart_push_smio_allow").style.display = "none"; } function smpushIntializePopupBox(){ jQuery("#smart_push_smio_window").remove(); jQuery("#smart_push_smio_overlay").remove(); jQuery("body").append('<style> #smart_push_smio_window{ direction:ltr;display: none;width:540px;max-width: 87%;background-color: #373737; font-family: Helvetica Neue, Helvetica, Arial, sans-serif; padding: 12px 0; border-radius: 5px; text-align: left; overflow: hidden; z-index: 99999999; } #smart_push_smio_logo{ float:left;width:80px;height:80px;margin-left:10px;border:0; } #smart_push_smio_msg{ margin-left:100px;margin-top: 23px;color: #e1e1df; font-size: 18px; font-weight: 300;padding: 0 5px 0 0;line-height: normal; } #smart_push_smio_note{ color: #828284;font-size: 15px;font-weight: 300; position: relative;margin:56px 0 20px 0;padding:20px 5px;line-height: normal;border-top: solid 1px #464646;border-bottom: solid 1px #464646;text-align: center; } #smart_push_smio_agreement{ color: #828284;font-size: 12px;font-weight: 300; position: relative;padding:0 10px 10px 10px;line-height: normal; } #smart_push_smio_footer{ text-align: center; } #smart_push_smio_not_allow{ background-color: #5f5f5f;text-transform: none; color: #929292; border: none; box-shadow: none; font-size: 17px; font-weight: 500; -webkit-border-radius: 20px; border-radius: 20px; padding: 10px 32px; margin: 5px; cursor: pointer; } #smart_push_smio_allow{ background-color: #5db166;text-transform: none; color: #fff; border: none; box-shadow: none; font-size: 17px; font-weight: 500; -webkit-border-radius: 20px; border-radius: 20px; padding: 10px 32px; margin: 5px ; cursor: pointer; } </style> <div id="smart_push_smio_overlay" tabindex="-1" style="opacity:0.9; display: none;ms-filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=40); background-color:#000; position: fixed; left: 0; right: 0; top: 0; bottom: 0; z-index: 10000;"></div> <div id="smart_push_smio_window" class="smart_push_gdpr_enabled"> <div id="smart_push_smio_close" onclick="smpushDestroyReqWindow(true)" style="display:none"></div> <img id="smart_push_smio_logo" src="https://smart-local.com/wp/wp-content/uploads/2019/01/bIT66BZ__400x400-1-300x300.png" /> <p id="smart_push_smio_msg">Subscribe to receive new offers</p> <p id="smart_push_smio_note">You can choose to turn off notifications later anytime using browser settings.</p> <p id="smart_push_smio_agreement">By proceeding in this form you will receive our marketing notifications and agree to our <a href="https://smart-local.com/wp/privacy-policy" target="_blank">Privacy Policy</a> and <a href="https://smart-local.com/wp/terms-conditions" target="_blank">Terms of Use</a></p> <div id="smart_push_smio_footer"> <button type="button" onclick="smpushDestroyReqWindow(true)" id="smart_push_smio_not_allow">Disallow</button> <button type="button" class="smpush-push-permission-button" id="smart_push_smio_allow" disabled>Subscribe</button> </div> </div> '); document.getElementById("smart_push_smio_overlay").style.opacity = "0.9"; document.getElementById("smart_push_smio_window").style.position = "fixed"; document.getElementById("smart_push_smio_overlay").style.display = "block"; document.getElementById("smart_push_smio_window").style.display = "block"; var position = "center"; if(position == "topright"){ document.getElementById("smart_push_smio_window").style.right = "10px"; document.getElementById("smart_push_smio_window").style.top = "10px"; } else if(position == "topleft"){ document.getElementById("smart_push_smio_window").style.left = "10px"; document.getElementById("smart_push_smio_window").style.top = "10px"; } else if(position == "bottomright"){ document.getElementById("smart_push_smio_window").style.bottom = "10px"; document.getElementById("smart_push_smio_window").style.right = "10px"; } else if(position == "bottomleft"){ document.getElementById("smart_push_smio_window").style.left = "10px"; document.getElementById("smart_push_smio_window").style.bottom = "10px"; } else if(position == "topcenter"){ document.getElementById("smart_push_smio_window").style.left = ((window.innerWidth/2) - (document.getElementById("smart_push_smio_window").offsetWidth/2)) + "px"; document.getElementById("smart_push_smio_window").style.top = "0"; } else{ document.getElementById("smart_push_smio_window").style.left = ((window.innerWidth/2) - (document.getElementById("smart_push_smio_window").offsetWidth/2)) + "px"; document.getElementById("smart_push_smio_window").style.top = ((window.innerHeight/2) - (document.getElementById("smart_push_smio_window").offsetHeight/2)) + "px"; } } function smpushDrawReqWindow(){ if("popup" == "popup"){ smpushIntializePopupBox(); } else if("popup" == "subs_page"){ } else{ if("0" == "1"){ jQuery("body").append('<div id="smart_push_smio_overlay" tabindex="-1" style="opacity:0.9; display: block;ms-filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=40); background-color:#000; position: fixed; left: 0; right: 0; top: 0; bottom: 0; z-index: 10000;"></div>'); } jQuery("body").append("<button class=\"smpush-push-permission-button\" style=\"display:none\" disabled>Subscribe</button>"); } if ("safari" in window) { smpushSafari(); } else { smpushGeko(); } } function smpushDrawReqIcon(){ if("1" == "1"){ jQuery("body").append("<div class=\"tooltip_templates\"><div id=\"smpush_tooltip_gdpr_ver_text\"><img src=\"https://smart-local.com/wp/wp-content/uploads/2019/01/bIT66BZ__400x400-1-300x300.png\" /><p>Give us a permission to receive push notification messages and we will keep you posted !</p><p id=\"smpush_gdpr_hint\">By proceeding in this form you will receive our marketing notifications and agree to our #Privacy Policy# and #Terms of Use#</p></div></div>"); jQuery("body").append("<button class=\"smpush-push-permission-button smpushTooltip\" id=\"smpushIconRequest\" style=\"bottom: 10px; right: 10px;\" data-tooltip-content=\"#smpush_tooltip_gdpr_ver_text\" disabled></button>"); } else if("popup" == "icon"){ jQuery("body").append("<button class=\"smpush-push-permission-button smpushTooltip\" id=\"smpushIconRequest\" style=\"bottom: 10px; right: 10px;\" title=\"Give us a permission to receive push notification messages and we will keep you posted !\" disabled></button>"); } else{ return; } if("0" == "1"){ jQuery("body").append('<div id="smart_push_smio_overlay" tabindex="-1" style="opacity:0.9; display: block;ms-filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=40); background-color:#000; position: fixed; left: 0; right: 0; top: 0; bottom: 0; z-index: 10000;"></div>'); } jQuery("body").append("<style>#smpushIconRequest{display: block;position: fixed;width: 50px;height: 50px;background-image: url(https://smart-local.com/wp/wp-content/uploads/2019/01/bell.png);background-repeat: no-repeat;background-position: center;background-size: 40px 40px;text-indent: -9999px;padding: 0;margin: 0;border: 0;z-index: 999999999;border-radius: 50px;-webkit-border-radius: 50px;-moz-border-radius: 50px;-webkit-box-shadow: 7px 3px 16px 0px rgba(50, 50, 50, 0.2);-moz-box-shadow: 7px 3px 16px 0px rgba(50, 50, 50, 0.2);box-shadow:7px 3px 16px 0px rgba(50, 50, 50, 0.2);}</style>"); smpushTooltip(); if(smpush_getCookie("smpush_desktop_request") == "true"){ if ("safari" in window) { smpushSafari(); } else { smpushGeko(); } } } function smpush_link_user_cookies() { if(smpush_getCookie("smpush_fresh_linked_user") != "" && smpush_getCookie("smpush_linked_user") == "" && smpush_getCookie("smpush_device_token") != ""){ smpush_endpoint_subscribe(smpush_getCookie("smpush_device_token")); smpush_setCookie("smpush_linked_user", "true", 15); smpush_setCookie("smpush_fresh_linked_user", "", -1); } } function smpushWelcomeMSG(){ if(smpush_getCookie("smpush_desktop_welcmsg_seen") == "true"){ return; } if("0" == "1"){ setTimeout(function(){ window.location="http://localhost/wp8/privacy-policy/"; }, 4000); } if("1" == "0"){return;} smpush_setCookie("smpush_desktop_welcmsg_seen", "true", 365); if("safari" in window){ var n = new Notification( "Welcome :D", { "body": "Holla! you successfully subscribed with us.", "tag" : "http://localhost/wp8" } ); n.onclick = function () { this.close(); window.open("http://localhost/wp8", "_blank"); }; } else{ navigator.serviceWorker.ready.then(function(registration) { registration.showNotification("Welcome :D", { icon: "https://smart-local.com/wp/wp-content/uploads/2019/01/unnamed.png", body: "Holla! you successfully subscribed with us.", tag: "http://localhost/wp8", requireInteraction: true }); }); self.addEventListener("notificationclick", function (event) { event.notification.close(); event.waitUntil(clients.matchAll({ type: "window" }).then(function (clientList) { for (var i = 0; i < clientList.length; i++) { var client = clientList[i]; if (client.url === event.notification.tag && "focus" in client) { return client.focus(); } } if (clients.openWindow) { return clients.openWindow(event.notification.tag); } })); }); } } function smpush_setCookie(cname, cvalue, exdays) { var d = new Date(); d.setTime(d.getTime() + (exdays*24*60*60*1000)); var expires = "expires="+d.toUTCString(); document.cookie = cname + "=" + cvalue + "; " + expires + ";path=/wp/"; } function smpush_getCookie(cname) { var name = cname + "="; var ca = document.cookie.split(";"); for(var i=0; i<ca.length; i++) { var c = ca[i]; while (c.charAt(0)==" "){ c = c.substring(1); } if (c.indexOf(name) == 0) return c.substring(name.length,c.length); } return ""; } function smpushTooltip() { jQuery(".smpushTooltip").tooltipster({side: "left", contentCloning: true, interactive: true}); } if ("safari" in window && "pushNotification" in window.safari) { document.addEventListener("DOMContentLoaded", function(event) { smpush_bootstrap_init(); }); } else{ window.addEventListener("load", function() { smpush_bootstrap_init(); }); } function openFBpopup(url, elm){ var new_fbwindow = window.open(url, "", "width=800,height=600"); new_fbwindow.onbeforeunload = function(){ $(elm).hide(); } } if("0" == "0" || "0" == "1"){ document.getElementsByTagName("HEAD")[0].insertAdjacentHTML("afterbegin", "<link rel=\"manifest\" href=\"https://smart-local.com/wp/?smpushprofile=manifest\">"); } function smpush_endpointWorkaround(endpoint){ var device_id = ""; if(endpoint.indexOf("mozilla") > -1){ device_id = endpoint.split("/")[endpoint.split("/").length-1]; } else if(endpoint.indexOf("send/") > -1){ device_id = endpoint.slice(endpoint.search("send/")+5); } else{ smpush_debug(endpoint); smpush_debug("error while getting device_id from endpoint"); alert("error while getting device_id from endpoint"); window.close(); } smpush_debug(device_id); return device_id; } function smpush_sendSubscriptionToServer(subscription) { if("0" == "1"){ var subscriptionId = subscription; } else{ var subscriptionId = smpush_endpointWorkaround(subscription.endpoint); } smpush_debug(subscriptionId); if(smpush_getCookie("smpush_device_token") == ""){ smpush_endpoint_subscribe(subscriptionId); } else{ smpushDestroyReqWindow(false); } } function smpush_unsubscribe() { smpush_setCookie("smpush_desktop_request", "true", 10); var pushButton = jQuery(".smpush-push-permission-button"); pushButton.attr("disabled","disabled"); navigator.serviceWorker.ready.then(function(serviceWorkerRegistration) { serviceWorkerRegistration.pushManager.getSubscription().then( function(pushSubscription) { if (!pushSubscription) { smpush_isPushEnabled = false; pushButton.removeAttr("disabled"); pushButton.html("Subscribe"); return; } var subscriptionId = smpush_endpointWorkaround(pushSubscription.endpoint); smpush_debug(subscriptionId); smpush_endpoint_unsubscribe(subscriptionId); pushSubscription.unsubscribe().then(function() { pushButton.removeAttr("disabled"); pushButton.html("Subscribe"); smpush_isPushEnabled = false; }).catch(function(e) { smpush_debug("Unsubscription error: ", e); pushButton.removeAttr("disabled"); }); }).catch(function(e) { smpush_debug("Error thrown while unsubscribing from push messaging.", e); }); }); } function smpush_subscribe() { var pushButton = jQuery(".smpush-push-permission-button"); pushButton.attr("disabled","disabled"); if("0" == "1"){ var applicationServerKey = smpushUrlB64ToUint8Array("BDT6wR4EzxwXQw5_PnFX7LKpbsELODMdkqJ7CXNZu-Cs7t5kEOWSX8eebiKCebLQbc9dsCUnOZBIsMsM8ROycpA"); var subsConfig = { userVisibleOnly: true, applicationServerKey: applicationServerKey }; } else{ var subsConfig = { userVisibleOnly: true }; } navigator.serviceWorker.ready.then(function(serviceWorkerRegistration) { serviceWorkerRegistration.pushManager.subscribe(subsConfig) .then(function(subscription) { smpush_isPushEnabled = true; pushButton.html("Unsubscribe"); jQuery("#smpushIconRequest").tooltipster("content","Unsubscribe from receiving our notifications and delete your subscription"); pushButton.removeAttr("disabled"); if("0" == "1"){ let subscriptionData = JSON.parse(JSON.stringify(subscription)); let subscriptionServer = {"endpoint": subscriptionData.endpoint, "auth": subscriptionData.keys.auth, "p256dh": subscriptionData.keys.p256dh}; smpush_debug(subscriptionServer); return smpush_sendSubscriptionToServer(btoa(JSON.stringify(subscriptionServer))); } else{ return smpush_sendSubscriptionToServer(subscription); } }) .catch(function(e) { if (Notification.permission === "denied") { smpushDrawNotifyPopup(); smpush_debug("Permission for Notifications was denied"); pushButton.attr("disabled","disabled"); smpush_endpoint_unsubscribe(smpush_getCookie("smpush_device_token")); } else { smpush_debug(e); } }); }); } function smpush_initialiseState() { if (!("showNotification" in ServiceWorkerRegistration.prototype)) { smpush_debug("Notifications aren't supported."); return; } if (Notification.permission === "denied") { smpushDrawNotifyPopup(); smpush_debug("The user has blocked notifications."); smpush_endpoint_unsubscribe(smpush_getCookie("smpush_device_token")); return; } if (!("PushManager" in window)) { smpush_debug("Push messaging isn't supported."); return; } navigator.serviceWorker.ready.then(function(serviceWorkerRegistration) { serviceWorkerRegistration.pushManager.getSubscription() .then(function(subscription) { var pushButton = jQuery(".smpush-push-permission-button"); pushButton.removeAttr("disabled"); if (!subscription) { if("popup" == "native"){ document.getElementsByClassName("smpush-push-permission-button")[0].click(); } return; } pushButton.html("Unsubscribe"); jQuery("#smpushIconRequest").tooltipster("content","Unsubscribe from receiving our notifications and delete your subscription"); smpush_isPushEnabled = true; smpush_sendSubscriptionToServer(subscription); }) .catch(function(err) { smpush_debug("Error during getSubscription()", err); }); }); } function smpushGeko(){ if ("serviceWorker" in navigator) { if("0" == "1" && "0" == "0"){ navigator.serviceWorker.register("https://smart-local.com/wp/smart_push_sw.js").then(smpush_initialiseState).catch(function(error){ smpush_debug(error); }); } else{ navigator.serviceWorker.register("https://smart-local.com/wp/?smpushprofile=service_worker").then(smpush_initialiseState).catch(function(error){ smpush_debug(error); }); } } else { smpush_debug("Service workers aren't supported in this browser."); } if(jQuery(".smpush-push-permission-button").length < 1){ return false; } var pushButton = jQuery(".smpush-push-permission-button"); pushButton.click(function() { if (smpush_isPushEnabled) { smpush_unsubscribe(); } else { smpush_subscribe(); } }); jQuery(".smpush-push-subscriptions-button").click(function() { smpush_subscribe(); }); } function smpushSafari(){ var pushButton = jQuery(".smpush-push-permission-button"); pushButton.removeAttr("disabled"); if(smpush_getCookie("smpush_safari_device_token") != ""){ pushButton.html("Unsubscribe"); jQuery("#smpushIconRequest").tooltipster("content","Unsubscribe from receiving our notifications and delete your subscription"); } else{ pushButton.html("Subscribe"); } pushButton.click(function() { var permissionData = window.safari.pushNotification.permission("web.smart.system.final"); smpushCheckRemotePermission(permissionData); }); jQuery(".smpush-push-subscriptions-button").click(function() { var permissionData = window.safari.pushNotification.permission("web.smart.system.final"); smpushCheckRemotePermission(permissionData); }); if("popup" == "native"){ document.getElementsByClassName("smpush-push-permission-button")[0].click(); } } var smpushCheckRemotePermission = function (permissionData) { var pushButton = jQuery(".smpush-push-permission-button"); if (permissionData.permission === "default") { window.safari.pushNotification.requestPermission( "https://smart-local.com/wp/push/safari", "web.smart.system.final", {}, smpushCheckRemotePermission ); } else if (permissionData.permission === "denied") { if(smpush_getCookie("smpush_safari_device_token") != ""){ smpush_endpoint_unsubscribe(smpush_getCookie("smpush_safari_device_token")); } smpush_setCookie("smpush_desktop_request", "true", 10); smpush_setCookie("smpush_safari_device_token", "false", -1); smpush_setCookie("smpush_device_token", "false", -1); smpushDrawNotifyPopup(); } else if (permissionData.permission === "granted") { smpushDestroyReqWindow(false); if(smpush_getCookie("smpush_safari_device_token") != ""){ smpush_endpoint_unsubscribe(smpush_getCookie("smpush_safari_device_token")); smpush_setCookie("smpush_desktop_request", "true", 10); smpush_setCookie("smpush_safari_device_token", "false", -1); smpush_setCookie("smpush_device_token", "false", -1); smpush_setCookie("smpush_desktop_welcmsg_seen", "false", -1); pushButton.attr("disabled","disabled"); jQuery(".smpush-push-subscriptions-button").attr("disabled","disabled"); jQuery(".smpush-push-subscriptions-button").html("Saved !"); } else{ if(smpush_getCookie("smpush_safari_device_token") == ""){ smpush_setCookie("smpush_safari_device_token", permissionData.deviceToken, 365); smpush_endpoint_subscribe(permissionData.deviceToken); } else{ smpushDestroyReqWindow(false); } pushButton.attr("disabled","disabled"); jQuery(".smpush-push-subscriptions-button").attr("disabled","disabled"); jQuery(".smpush-push-subscriptions-button").html("Saved !"); } } }; 